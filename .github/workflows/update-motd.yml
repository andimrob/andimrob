name: Update MOTD

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: ['*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-motd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch profile data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          YEAR=$(date -u +%Y)

          QUERY='
          query($login: String!, $from: DateTime!, $to: DateTime!) {
            user(login: $login) {
              repositories(first: 100, ownerAffiliations: OWNER, orderBy: {field: PUSHED_AT, direction: DESC}, privacy: PUBLIC) {
                nodes {
                  name
                  isFork
                  pushedAt
                  stargazerCount
                  languages(first: 5, orderBy: {field: SIZE, direction: DESC}) {
                    nodes { name }
                  }
                }
              }
              followers { totalCount }
              contributionsCollection(from: $from, to: $to) {
                totalCommitContributions
                totalPullRequestContributions
                totalIssueContributions
                totalPullRequestReviewContributions
              }
            }
          }'

          RESULT=$(gh api graphql \
            -f query="$QUERY" \
            -f login="andimrob" \
            -f from="${YEAR}-01-01T00:00:00Z" \
            -f to="${YEAR}-12-31T23:59:59Z")

          # --- Last login (most recent push to a non-fork repo) ---
          LAST_PUSH=$(echo "$RESULT" | jq -r '
            [.data.user.repositories.nodes[] | select(.isFork == false)] | .[0].pushedAt
          ')
          if [ -n "$LAST_PUSH" ] && [ "$LAST_PUSH" != "null" ]; then
            LAST_LOGIN=$(date -d "$LAST_PUSH" +'%a %b %e %H:%M:%S %Y')
          else
            LAST_LOGIN="unknown"
          fi
          echo "$LAST_LOGIN" > /tmp/last_login.txt

          # --- Projects (top 5 recently pushed, excluding profile repo and forks) ---
          echo "$RESULT" | jq -r '
            [.data.user.repositories.nodes[]
              | select(.isFork == false and .name != "andimrob")]
            | .[0:5]
            | .[]
            | "  drwxr-xr-x  \(.name)/"
          ' > /tmp/projects.txt

          # --- Neofetch stats ---
          REPO_COUNT=$(echo "$RESULT" | jq -r '
            [.data.user.repositories.nodes[] | select(.isFork == false)] | length
          ')
          STARS=$(echo "$RESULT" | jq -r '
            [.data.user.repositories.nodes[] | select(.isFork == false) | .stargazerCount] | add // 0
          ')
          RAW_CONTRIBS=$(echo "$RESULT" | jq -r '
            .data.user.contributionsCollection
            | (.totalCommitContributions + .totalPullRequestContributions + .totalIssueContributions + .totalPullRequestReviewContributions)
          ')
          CONTRIBUTIONS=$(echo "$RAW_CONTRIBS" | sed -e :a -e 's/\(.*[0-9]\)\([0-9]\{3\}\)/\1,\2/;ta')
          FOLLOWERS=$(echo "$RESULT" | jq -r '.data.user.followers.totalCount')
          TOP_LANGS=$(echo "$RESULT" | jq -r '
            [.data.user.repositories.nodes[]
              | select(.isFork == false)
              | .languages.nodes[]
              | .name]
            | group_by(.)
            | sort_by(-length)
            | .[0:3]
            | .[]
            | .[0]
          ' | paste -sd ', ' -)

          cat > /tmp/neofetch.txt <<EOF
            rob@github
            ----------
            Repos: ${REPO_COUNT}
            Stars: ${STARS}
            Contributions: ${CONTRIBUTIONS}
            Top Languages: ${TOP_LANGS}
            Followers: ${FOLLOWERS}
          EOF

      - name: Generate README from template
        run: |
          cp README.template.md README.md

          LAST_LOGIN=$(cat /tmp/last_login.txt)
          sed -i "s|{{LAST_LOGIN}}|${LAST_LOGIN}|" README.md

          awk '/\{\{NEOFETCH\}\}/{while((getline line < "/tmp/neofetch.txt") > 0) print line; next}1' README.md > /tmp/readme_tmp && mv /tmp/readme_tmp README.md
          awk '/\{\{PROJECTS\}\}/{while((getline line < "/tmp/projects.txt") > 0) print line; next}1' README.md > /tmp/readme_tmp && mv /tmp/readme_tmp README.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git diff --quiet README.md || {
            git add README.md
            git commit -m "chore: update motd profile data"
            git push
          }
